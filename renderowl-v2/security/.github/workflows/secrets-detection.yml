name: Secrets Detection - GitLeaks

on:
  push:
    branches: [main, develop, 'feature/**']
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

jobs:
  gitleaks:
    name: GitLeaks Secrets Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run GitLeaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }} # Optional: for commercial features
        with:
          config-path: .gitleaks.toml

      - name: Run GitLeaks (CLI fallback)
        if: failure()
        run: |
          # Install GitLeaks if action fails
          curl -sSL https://github.com/gitleaks/gitleaks/releases/download/v8.18.2/gitleaks_8.18.2_linux_x64.tar.gz | tar -xz -C /tmp
          /tmp/gitleaks detect --source . --verbose --report-format sarif --report-path gitleaks-results.sarif

      - name: Upload SARIF to GitHub Security Tab
        uses: github/codeql-action/upload-sarif@v3
        if: always() && hashFiles('gitleaks-results.sarif') != ''
        with:
          sarif_file: gitleaks-results.sarif
          category: gitleaks

      - name: Upload results as artifact
        uses: actions/upload-artifact@v4
        if: always() && hashFiles('gitleaks-results.sarif') != ''
        with:
          name: gitleaks-results
          path: gitleaks-results.sarif
          retention-days: 30

  # Additional scan with TruffleHog for comprehensive coverage
  trufflehog:
    name: TruffleHog Secrets Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: TruffleHog OSS
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD
          extra_args: --debug --only-verified

      - name: Generate secrets report
        run: |
          echo "# Secrets Detection Report" > secrets-report.md
          echo "Generated: $(date -u)" >> secrets-report.md
          echo "" >> secrets-report.md
          echo "## Tools Used" >> secrets-report.md
          echo "- GitLeaks: Primary secrets scanner" >> secrets-report.md
          echo "- TruffleHog: Secondary verification" >> secrets-report.md
          echo "" >> secrets-report.md
          echo "## Policy" >> secrets-report.md
          echo "- Any secrets detected must be immediately revoked and rotated" >> secrets-report.md
          echo "- Secrets should never be committed to the repository" >> secrets-report.md
          echo "- Use GitHub Secrets or a secrets manager (e.g., HashiCorp Vault, AWS Secrets Manager)" >> secrets-report.md
