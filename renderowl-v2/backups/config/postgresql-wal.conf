# PostgreSQL WAL Archiving Configuration
# For Renderowl 2.0 - Point-in-Time Recovery (PITR)

# ============================================
# postgresql.conf Settings
# ============================================

# Enable WAL archiving
wal_level = replica                    # Minimum for archiving
archive_mode = on                      # Enable archiving
archive_command = 'wal-g wal-push %p'  # Use wal-g for cloud storage
archive_timeout = 600                  # Force archive every 10 minutes (600s)

# WAL retention for PITR
wal_keep_size = 1GB                    # Keep extra WAL files
max_wal_size = 4GB
min_wal_size = 1GB

# Connection settings for replication/backups
max_connections = 200
max_wal_senders = 10                   # Allow multiple concurrent backups
max_replication_slots = 10

# Performance tuning for archiving
checkpoint_completion_target = 0.9
random_page_cost = 1.1

# Logging
log_directory = 'log'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_rotation_age = 1d
log_rotation_size = 100MB
log_min_messages = warning
log_min_error_statement = error
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '

# ============================================
# postgresql.auto.conf (for ALTER SYSTEM)
# ============================================
# Run these commands as superuser:
#
# ALTER SYSTEM SET wal_level = 'replica';
# ALTER SYSTEM SET archive_mode = 'on';
# ALTER SYSTEM SET archive_command = 'wal-g wal-push %p';
# ALTER SYSTEM SET archive_timeout = '600';
# ALTER SYSTEM SET max_wal_senders = '10';
# ALTER SYSTEM SET max_replication_slots = '10';
# SELECT pg_reload_conf();
#
# Note: archive_mode requires PostgreSQL restart to change

# ============================================
# Recovery Configuration (recovery.conf / postgresql.conf for PG12+)
# ============================================
# Used when restoring from backup

# restore_command = 'wal-g wal-fetch %f %p'
# recovery_target_time = '2024-01-15 14:30:00'  # Example: PITR target
# recovery_target_action = 'promote'

# ============================================
# pg_hba.conf Entries for Backup Operations
# ============================================
# Allow backup connections from backup tooling

# TYPE  DATABASE        USER            ADDRESS                 METHOD
local   replication     postgres                                peer
host    replication     postgres        127.0.0.1/32            scram-sha-256
host    replication     postgres        ::1/128                 scram-sha-256
host    replication     replicator      10.0.0.0/8              scram-sha-256
host    all             backup_user     10.0.0.0/8              scram-sha-256

# ============================================
# Required PostgreSQL User
# ============================================

# CREATE USER backup_user WITH REPLICATION PASSWORD 'secure_password';
# GRANT CONNECT ON DATABASE renderowl TO backup_user;
# GRANT USAGE ON SCHEMA public TO backup_user;
# GRANT SELECT ON ALL TABLES IN SCHEMA public TO backup_user;
# ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT SELECT ON TABLES TO backup_user;
