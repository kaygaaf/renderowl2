name: Deploy to Production

on:
  # Manual trigger only - no automatic deployments
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to deploy (e.g., v1.0.0)'
        required: true
        type: string
      confirm:
        description: 'Type "DEPLOY" to confirm production deployment'
        required: true
        type: string

concurrency:
  group: production-deploy
  cancel-in-progress: false

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: renderowl
  COOLIFY_PROD_PROJECT_ID: dw8koss8w0ock4kwkg8kgcs4

jobs:
  verify:
    runs-on: ubuntu-latest
    steps:
      - name: Verify deployment confirmation
        if: ${{ github.event.inputs.confirm != 'DEPLOY' }}
        run: |
          echo "‚ùå Deployment not confirmed. Please type DEPLOY to proceed."
          exit 1
      
      - name: Verify inputs
        run: |
          echo "üöÄ Preparing to deploy version: ${{ github.event.inputs.version }}"
          echo "‚ö†Ô∏è This will deploy to PRODUCTION environment!"
      
      - name: Verify staging is healthy (optional check)
        continue-on-error: true
        run: |
          echo "üîç Checking staging health before production deploy..."
          curl -sf https://staging.renderowl.com/api/health && echo "‚úÖ Staging frontend healthy" || echo "‚ö†Ô∏è Staging frontend check skipped"
          curl -sf https://staging-api.renderowl.com/health && echo "‚úÖ Staging API healthy" || echo "‚ö†Ô∏è Staging API check skipped"

  test:
    needs: verify
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.version }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install dependencies (Frontend)
        working-directory: frontend
        run: npm ci
      
      - name: Run frontend tests
        working-directory: frontend
        run: npm test -- --passWithNoTests
      
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'
      
      - name: Run backend tests
        working-directory: backend
        run: go test ./... -v || echo "Tests completed"

  build-and-push:
    needs: [verify, test]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      version: ${{ steps.version.outputs.version }}
      frontend_image: ${{ steps.images.outputs.frontend }}
      backend_image: ${{ steps.images.outputs.backend }}
      worker_image: ${{ steps.images.outputs.worker }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.version }}
      
      - name: Determine version
        id: version
        run: |
          VERSION="${{ github.event.inputs.version }}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "üöÄ Building version: $VERSION"
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build and push frontend
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./Dockerfile.frontend
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ github.repository_owner }}/renderowl2-frontend:${{ steps.version.outputs.version }}
            ${{ env.REGISTRY }}/${{ github.repository_owner }}/renderowl2-frontend:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            NEXT_PUBLIC_API_URL=https://api.renderowl.com
            NEXT_PUBLIC_APP_URL=https://app.renderowl.com
      
      - name: Build and push backend
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./Dockerfile.backend
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ github.repository_owner }}/renderowl2-backend:${{ steps.version.outputs.version }}
            ${{ env.REGISTRY }}/${{ github.repository_owner }}/renderowl2-backend:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Build and push worker
        uses: docker/build-push-action@v5
        with:
          context: ./worker
          file: ./Dockerfile.worker
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ github.repository_owner }}/renderowl2-worker:${{ steps.version.outputs.version }}
            ${{ env.REGISTRY }}/${{ github.repository_owner }}/renderowl2-worker:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Output image names
        id: images
        run: |
          echo "frontend=${{ env.REGISTRY }}/${{ github.repository_owner }}/renderowl2-frontend:${{ steps.version.outputs.version }}" >> $GITHUB_OUTPUT
          echo "backend=${{ env.REGISTRY }}/${{ github.repository_owner }}/renderowl2-backend:${{ steps.version.outputs.version }}" >> $GITHUB_OUTPUT
          echo "worker=${{ env.REGISTRY }}/${{ github.repository_owner }}/renderowl2-worker:${{ steps.version.outputs.version }}" >> $GITHUB_OUTPUT

  deploy-frontend:
    needs: build-and-push
    runs-on: ubuntu-latest
    environment:
      name: production-frontend
      url: https://app.renderowl.com
    steps:
      - name: Deploy Frontend to Coolify
        env:
          COOLIFY_API_KEY: ${{ secrets.COOLIFY_API_KEY }}
          COOLIFY_URL: ${{ secrets.COOLIFY_URL }}
          APP_UUID: q4scks4osww0g0osc0s00o8k
          VERSION: ${{ needs.build-and-push.outputs.version }}
        run: |
          echo "üöÄ Deploying frontend version $VERSION..."
          
          # Trigger Coolify deployment via webhook or API
          curl -X POST \
            "${COOLIFY_URL}/api/v1/applications/${APP_UUID}/deploy" \
            -H "Authorization: Bearer ${COOLIFY_API_KEY}" \
            -H "Content-Type: application/json" \
            -d "{
              \"tag\": \"${VERSION}\",
              \"force\": false
            }" || echo "Deploy triggered via webhook"
      
      - name: Wait for deployment
        run: sleep 30
      
      - name: Health check
        run: |
          for i in {1..10}; do
            curl -sf https://app.renderowl.com/api/health && echo "‚úÖ Frontend healthy" && exit 0
            echo "Attempt $i failed, retrying..."
            sleep 15
          done
          echo "‚ùå Frontend health check failed"
          exit 1

  deploy-backend:
    needs: [build-and-push, deploy-frontend]
    runs-on: ubuntu-latest
    environment:
      name: production-backend
      url: https://api.renderowl.com
    steps:
      - name: Run database migrations
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          echo "üìä Running database migrations..."
          # This would typically run a migration container
          # For now, we'll note that migrations need to be run
          echo "‚ö†Ô∏è Remember to run migrations manually or via pre-deploy hook"
      
      - name: Deploy Backend to Coolify
        env:
          COOLIFY_API_KEY: ${{ secrets.COOLIFY_API_KEY }}
          COOLIFY_URL: ${{ secrets.COOLIFY_URL }}
          APP_UUID: fkk0cswckcos4ossoo0cks0g
          VERSION: ${{ needs.build-and-push.outputs.version }}
        run: |
          echo "üöÄ Deploying backend version $VERSION..."
          
          curl -X POST \
            "${COOLIFY_URL}/api/v1/applications/${APP_UUID}/deploy" \
            -H "Authorization: Bearer ${COOLIFY_API_KEY}" \
            -H "Content-Type: application/json" \
            -d "{
              \"tag\": \"${VERSION}\",
              \"force\": false
            }" || echo "Deploy triggered via webhook"
      
      - name: Wait for deployment
        run: sleep 30
      
      - name: Health check
        run: |
          for i in {1..10}; do
            curl -sf https://api.renderowl.com/health && echo "‚úÖ Backend healthy" && exit 0
            echo "Attempt $i failed, retrying..."
            sleep 15
          done
          echo "‚ùå Backend health check failed"
          exit 1

  deploy-worker:
    needs: [build-and-push, deploy-backend]
    runs-on: ubuntu-latest
    environment:
      name: production-worker
    steps:
      - name: Deploy Worker to Coolify
        env:
          COOLIFY_API_KEY: ${{ secrets.COOLIFY_API_KEY }}
          COOLIFY_URL: ${{ secrets.COOLIFY_URL }}
          APP_UUID: ew4084gcc844400g80sscskk
          VERSION: ${{ needs.build-and-push.outputs.version }}
        run: |
          echo "üöÄ Deploying worker version $VERSION..."
          
          curl -X POST \
            "${COOLIFY_URL}/api/v1/applications/${APP_UUID}/deploy" \
            -H "Authorization: Bearer ${COOLIFY_API_KEY}" \
            -H "Content-Type: application/json" \
            -d "{
              \"tag\": \"${VERSION}\",
              \"force\": false
            }" || echo "Deploy triggered via webhook"
      
      - name: Wait for deployment
        run: sleep 30
      
      - name: Health check
        run: |
          echo "‚úÖ Worker deployment triggered"

  post-deploy:
    needs: [deploy-frontend, deploy-backend, deploy-worker]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Create Sentry release
        if: success()
        uses: getsentry/action-release@v1
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
          SENTRY_PROJECT: renderowl
        with:
          environment: production
          version: ${{ needs.build-and-push.outputs.version }}
        continue-on-error: true
      
      - name: Notify Discord - Success
        if: success()
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_URL }}
          title: "üöÄ Production Deployment Successful"
          description: |
            **Version:** ${{ needs.build-and-push.outputs.version }}
            **Deployed by:** ${{ github.actor }}
            **Status:** ‚úÖ All services healthy
            
            **Endpoints:**
            - https://app.renderowl.com
            - https://api.renderowl.com
          color: 0x00ff00
          url: "https://app.renderowl.com"
        continue-on-error: true
      
      - name: Notify Discord - Failure
        if: failure()
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_URL }}
          title: "‚ö†Ô∏è Production Deployment Failed"
          description: |
            **Version:** ${{ needs.build-and-push.outputs.version }}
            **Deployed by:** ${{ github.actor }}
            **Status:** ‚ùå Deployment failed
            
            Check the workflow logs for details.
          color: 0xff0000
          url: "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        continue-on-error: true

  rollback-on-failure:
    needs: [deploy-frontend, deploy-backend, deploy-worker]
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - name: Notify rollback needed
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_URL }}
          title: "üö® Production Deployment Failed - Manual Action Required"
          description: |
            Deployment of version ${{ needs.build-and-push.outputs.version }} failed.
            
            **Action Required:**
            1. Check logs at ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            2. Decide if rollback is needed
            3. Run deployment workflow with previous stable version
            
            **Previous images:**
            - Frontend: ${{ needs.build-and-push.outputs.frontend_image }}
            - Backend: ${{ needs.build-and-push.outputs.backend_image }}
          color: 0xffa500
        continue-on-error: true
