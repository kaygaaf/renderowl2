"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.TimelineExpandedSection = void 0;
const jsx_runtime_1 = require("react/jsx-runtime");
const react_1 = require("react");
const remotion_1 = require("remotion");
const client_id_1 = require("../../helpers/client-id");
const colors_1 = require("../../helpers/colors");
const timeline_layout_1 = require("../../helpers/timeline-layout");
const call_api_1 = require("../call-api");
const TimelineSchemaField_1 = require("./TimelineSchemaField");
const expandedSectionBase = {
    color: 'white',
    fontFamily: 'Arial, Helvetica, sans-serif',
    fontSize: 12,
    display: 'flex',
    flexDirection: 'column',
    paddingLeft: 28,
    paddingRight: 10,
    borderBottom: `1px solid ${colors_1.TIMELINE_TRACK_SEPARATOR}`,
};
const fieldRow = {
    display: 'flex',
    alignItems: 'center',
    gap: 8,
};
const fieldName = {
    fontSize: 12,
};
const fieldLabelRow = {
    flex: 1,
    display: 'flex',
    flexDirection: 'row',
    alignItems: 'center',
    gap: 6,
};
const TimelineFieldRow = ({ field, onSave, onDragValueChange, onDragEnd, propStatus }) => {
    var _a, _b;
    return (jsx_runtime_1.jsxs("div", { style: { ...fieldRow, height: field.rowHeight }, children: [
            jsx_runtime_1.jsx("div", { style: fieldLabelRow, children: jsx_runtime_1.jsx("span", { style: fieldName, children: (_a = field.description) !== null && _a !== void 0 ? _a : field.key }) }), jsx_runtime_1.jsx(TimelineSchemaField_1.TimelineFieldValue, { field: field, propStatus: propStatus, onSave: onSave, onDragValueChange: onDragValueChange, onDragEnd: onDragEnd, canUpdate: (_b = propStatus === null || propStatus === void 0 ? void 0 : propStatus.canUpdate) !== null && _b !== void 0 ? _b : false })
        ] }));
};
const TimelineExpandedSection = ({ sequence, originalLocation }) => {
    var _a;
    var _b, _c, _d, _e;
    const [propStatuses, setPropStatuses] = (0, react_1.useState)(null);
    const { previewServerState: state, subscribeToEvent } = (0, react_1.useContext)(client_id_1.StudioServerConnectionCtx);
    const clientId = state.type === 'connected' ? state.clientId : undefined;
    const schemaFields = (0, react_1.useMemo)(() => (0, timeline_layout_1.getSchemaFields)(sequence.controls), [sequence.controls]);
    const validatedLocation = (0, react_1.useMemo)(() => {
        var _a;
        if (!originalLocation ||
            !originalLocation.source ||
            !originalLocation.line) {
            return null;
        }
        return {
            source: originalLocation.source,
            line: originalLocation.line,
            column: (_a = originalLocation.column) !== null && _a !== void 0 ? _a : 0,
        };
    }, [originalLocation]);
    const locationSource = (_b = validatedLocation === null || validatedLocation === void 0 ? void 0 : validatedLocation.source) !== null && _b !== void 0 ? _b : null;
    const locationLine = (_c = validatedLocation === null || validatedLocation === void 0 ? void 0 : validatedLocation.line) !== null && _c !== void 0 ? _c : null;
    const locationColumn = (_d = validatedLocation === null || validatedLocation === void 0 ? void 0 : validatedLocation.column) !== null && _d !== void 0 ? _d : null;
    const schemaKeysString = (0, react_1.useMemo)(() => (schemaFields ? schemaFields.map((f) => f.key).join(',') : null), [schemaFields]);
    const currentLocationSource = (0, react_1.useRef)(locationSource);
    currentLocationSource.current = locationSource;
    const currentLocationLine = (0, react_1.useRef)(locationLine);
    currentLocationLine.current = locationLine;
    const currentLocationColumn = (0, react_1.useRef)(locationColumn);
    currentLocationColumn.current = locationColumn;
    (0, react_1.useEffect)(() => {
        if (!clientId ||
            !locationSource ||
            !locationLine ||
            locationColumn === null ||
            !schemaKeysString) {
            setPropStatuses(null);
            return;
        }
        const keys = schemaKeysString.split(',');
        (0, call_api_1.callApi)('/api/subscribe-to-sequence-props', {
            fileName: locationSource,
            line: locationLine,
            column: locationColumn,
            keys,
            clientId,
        })
            .then((result) => {
            if (currentLocationSource.current !== locationSource ||
                currentLocationLine.current !== locationLine ||
                currentLocationColumn.current !== locationColumn) {
                return;
            }
            if (result.canUpdate) {
                setPropStatuses(result.props);
            }
            else {
                setPropStatuses(null);
            }
        })
            .catch(() => {
            setPropStatuses(null);
        });
        return () => {
            (0, call_api_1.callApi)('/api/unsubscribe-from-sequence-props', {
                fileName: locationSource,
                line: locationLine,
                column: locationColumn,
                clientId,
            }).catch(() => {
                // Ignore unsubscribe errors
            });
        };
    }, [
        clientId,
        locationSource,
        locationLine,
        locationColumn,
        schemaKeysString,
    ]);
    (0, react_1.useEffect)(() => {
        if (!locationSource || !locationLine || locationColumn === null) {
            return;
        }
        const listener = (event) => {
            if (event.type !== 'sequence-props-updated') {
                return;
            }
            if (event.fileName !== currentLocationSource.current ||
                event.line !== currentLocationLine.current ||
                event.column !== currentLocationColumn.current) {
                return;
            }
            if (event.result.canUpdate) {
                setPropStatuses(event.result.props);
            }
            else {
                setPropStatuses(null);
            }
        };
        const unsub = subscribeToEvent('sequence-props-updated', listener);
        return () => {
            unsub();
        };
    }, [locationSource, locationLine, locationColumn, subscribeToEvent]);
    const expandedHeight = (0, react_1.useMemo)(() => (0, timeline_layout_1.getExpandedTrackHeight)(sequence.controls), [sequence.controls]);
    const { setOverride, clearOverrides } = (0, react_1.useContext)(remotion_1.Internals.SequenceControlOverrideContext);
    const onSave = (0, react_1.useCallback)((key, value) => {
        if (!propStatuses || !validatedLocation) {
            return Promise.reject(new Error('Cannot save'));
        }
        const status = propStatuses[key];
        if (!status || !status.canUpdate) {
            return Promise.reject(new Error('Cannot save'));
        }
        const field = schemaFields === null || schemaFields === void 0 ? void 0 : schemaFields.find((f) => f.key === key);
        const defaultValue = field && field.fieldSchema.default !== undefined
            ? JSON.stringify(field.fieldSchema.default)
            : null;
        return (0, call_api_1.callApi)('/api/save-sequence-props', {
            fileName: validatedLocation.source,
            line: validatedLocation.line,
            column: validatedLocation.column,
            key,
            value: JSON.stringify(value),
            enumPaths: [],
            defaultValue,
        }).then(() => undefined);
    }, [propStatuses, validatedLocation, schemaFields]);
    const overrideId = (_e = (_a = sequence.controls) === null || _a === void 0 ? void 0 : _a.overrideId) !== null && _e !== void 0 ? _e : sequence.id;
    const onDragValueChange = (0, react_1.useCallback)((key, value) => {
        setOverride(overrideId, key, value);
    }, [setOverride, overrideId]);
    const onDragEnd = (0, react_1.useCallback)(() => {
        clearOverrides(overrideId);
    }, [clearOverrides, overrideId]);
    return (jsx_runtime_1.jsx("div", { style: { ...expandedSectionBase, height: expandedHeight }, children: schemaFields
            ? schemaFields.map((field) => {
                var _a;
                return (jsx_runtime_1.jsx(TimelineFieldRow, { field: field, propStatus: (_a = propStatuses === null || propStatuses === void 0 ? void 0 : propStatuses[field.key]) !== null && _a !== void 0 ? _a : null, onSave: onSave, onDragValueChange: onDragValueChange, onDragEnd: onDragEnd }, field.key));
            })
            : 'No schema' }));
};
exports.TimelineExpandedSection = TimelineExpandedSection;
