apiVersion: batch/v1
kind: CronJob
metadata:
  name: postgres-full-backup
  namespace: renderowl
  labels:
    app: postgres-backup
    component: full-backup
spec:
  schedule: "0 2 * * *"  # Daily at 2:00 AM
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      backoffLimit: 3
      template:
        metadata:
          labels:
            app: postgres-backup
            component: full-backup
        spec:
          restartPolicy: OnFailure
          containers:
          - name: backup
            image: postgres:15-alpine
            command: ["/bin/sh"]
            args:
            - -c
            - |
              apk add --no-cache aws-cli zstd age
              /scripts/backup.sh full
            env:
            - name: DB_HOST
              valueFrom:
                secretKeyRef:
                  name: postgres-backup-secrets
                  key: db-host
            - name: DB_PORT
              value: "5432"
            - name: DB_USER
              valueFrom:
                secretKeyRef:
                  name: postgres-backup-secrets
                  key: db-user
            - name: DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: postgres-backup-secrets
                  key: db-password
            - name: DB_NAME
              valueFrom:
                configMapKeyRef:
                  name: postgres-backup-config
                  key: db-name
            - name: ENVIRONMENT
              valueFrom:
                configMapKeyRef:
                  name: postgres-backup-config
                  key: environment
            - name: S3_ENDPOINT
              valueFrom:
                secretKeyRef:
                  name: postgres-backup-secrets
                  key: s3-endpoint
            - name: S3_BUCKET
              valueFrom:
                configMapKeyRef:
                  name: postgres-backup-config
                  key: s3-bucket
            - name: S3_ACCESS_KEY_ID
              valueFrom:
                secretKeyRef:
                  name: postgres-backup-secrets
                  key: s3-access-key-id
            - name: S3_SECRET_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: postgres-backup-secrets
                  key: s3-secret-access-key
            - name: AGE_PUBLIC_KEY
              valueFrom:
                secretKeyRef:
                  name: postgres-backup-secrets
                  key: age-public-key
            - name: BACKUP_DIR
              value: "/backups"
            volumeMounts:
            - name: scripts
              mountPath: /scripts
              readOnly: true
            - name: backup-temp
              mountPath: /backups
            resources:
              requests:
                memory: "256Mi"
                cpu: "100m"
              limits:
                memory: "1Gi"
                cpu: "500m"
          volumes:
          - name: scripts
            configMap:
              name: postgres-backup-scripts
              defaultMode: 0755
          - name: backup-temp
            emptyDir:
              sizeLimit: 10Gi
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: postgres-retention
  namespace: renderowl
  labels:
    app: postgres-backup
    component: retention
spec:
  schedule: "0 3 * * *"  # Daily at 3:00 AM (after backup)
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      backoffLimit: 3
      template:
        metadata:
          labels:
            app: postgres-backup
            component: retention
        spec:
          restartPolicy: OnFailure
          containers:
          - name: retention
            image: amazon/aws-cli:latest
            command: ["/bin/sh"]
            args:
            - -c
            - |
              apk add --no-cache bash
              /scripts/retention.sh all
            env:
            - name: ENVIRONMENT
              valueFrom:
                configMapKeyRef:
                  name: postgres-backup-config
                  key: environment
            - name: S3_ENDPOINT
              valueFrom:
                secretKeyRef:
                  name: postgres-backup-secrets
                  key: s3-endpoint
            - name: S3_BUCKET
              valueFrom:
                configMapKeyRef:
                  name: postgres-backup-config
                  key: s3-bucket
            - name: S3_ACCESS_KEY_ID
              valueFrom:
                secretKeyRef:
                  name: postgres-backup-secrets
                  key: s3-access-key-id
            - name: S3_SECRET_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: postgres-backup-secrets
                  key: s3-secret-access-key
            volumeMounts:
            - name: scripts
              mountPath: /scripts
              readOnly: true
            resources:
              requests:
                memory: "128Mi"
                cpu: "50m"
              limits:
                memory: "256Mi"
                cpu: "200m"
          volumes:
          - name: scripts
            configMap:
              name: postgres-backup-scripts
              defaultMode: 0755
