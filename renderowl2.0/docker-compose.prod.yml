# Renderowl 2.0 - Production
# Deployed via Coolify
# Run: docker-compose -f docker-compose.prod.yml up -d

version: "3.9"

services:
  # Frontend (Next.js)
  frontend:
    image: ${REGISTRY:-ghcr.io/kayorama}/renderowl-frontend:${TAG:-latest}
    container_name: renderowl-frontend
    environment:
      NODE_ENV: production
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL}
      NEXT_PUBLIC_APP_URL: ${NEXT_PUBLIC_APP_URL}
      NEXT_PUBLIC_SENTRY_DSN: ${NEXT_PUBLIC_SENTRY_DSN}
      NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY: ${NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY}
    ports:
      - "3000:3000"
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M

  # Backend API
  backend:
    image: ${REGISTRY:-ghcr.io/kayorama}/renderowl-backend:${TAG:-latest}
    container_name: renderowl-backend
    environment:
      ENVIRONMENT: production
      PORT: 8080
      DATABASE_URL: ${DATABASE_URL}
      REDIS_URL: ${REDIS_URL}
      S3_ENDPOINT: ${S3_ENDPOINT}
      S3_ACCESS_KEY: ${S3_ACCESS_KEY}
      S3_SECRET_KEY: ${S3_SECRET_KEY}
      S3_BUCKET_UPLOADS: ${S3_BUCKET_UPLOADS:-renderowl-uploads}
      S3_BUCKET_EXPORTS: ${S3_BUCKET_EXPORTS:-renderowl-exports}
      JWT_SECRET: ${JWT_SECRET}
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY}
      SENTRY_DSN: ${SENTRY_DSN}
    ports:
      - "8080:8080"
    healthcheck:
      test: ["CMD", "/usr/local/bin/renderowl-api", "health-check"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G

  # Video Rendering Worker (GPU-enabled)
  worker:
    image: ${REGISTRY:-ghcr.io/kayorama}/renderowl-worker:${TAG:-latest}
    container_name: renderowl-worker
    environment:
      NODE_ENV: production
      REDIS_URL: ${REDIS_URL}
      API_URL: http://backend:8080
      S3_ENDPOINT: ${S3_ENDPOINT}
      S3_ACCESS_KEY: ${S3_ACCESS_KEY}
      S3_SECRET_KEY: ${S3_SECRET_KEY}
      S3_BUCKET_UPLOADS: ${S3_BUCKET_UPLOADS:-renderowl-uploads}
      S3_BUCKET_EXPORTS: ${S3_BUCKET_EXPORTS:-renderowl-exports}
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      CONCURRENT_JOBS: ${CONCURRENT_JOBS:-2}
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3001/health', (r) => r.statusCode === 200 ? process.exit(0) : process.exit(1))"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 8G
        reservations:
          cpus: '2'
          memory: 4G

  # Worker scaler (auto-scaling workers based on queue depth)
  worker-scaler:
    image: ${REGISTRY:-ghcr.io/kayorama}/renderowl-backend:${TAG:-latest}
    container_name: renderowl-worker-scaler
    environment:
      ENVIRONMENT: production
      REDIS_URL: ${REDIS_URL}
      ROLE: scaler
    command: ["/usr/local/bin/renderowl-worker", "--mode=scaler"]
    depends_on:
      - backend
    restart: unless-stopped

  # Nginx Reverse Proxy
  nginx:
    image: nginx:alpine
    container_name: renderowl-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - nginx_cache:/var/cache/nginx
    depends_on:
      - frontend
      - backend
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost/health"]
      interval: 30s
      timeout: 3s
      retries: 3
    restart: unless-stopped

volumes:
  nginx_cache:

networks:
  default:
    name: renderowl-network
    driver: bridge
